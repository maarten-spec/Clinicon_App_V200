<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinicon Insights - Stellenplan</title>
  <style>
  /* STYLE-START */
  @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap");
  :root{
    --bg:#f6f2ea;
    --bg-ink:#0d1433;
    --bg-grad:radial-gradient(1200px 680px at 90% -10%, rgba(255,110,64,0.18), transparent 60%),
      radial-gradient(1000px 520px at -10% 0%, rgba(24,196,190,0.18), transparent 58%),
      linear-gradient(180deg, #fff7ee 0%, #f4f6fb 100%);
    --surface:#ffffff;
    --surface-2:#f1f5fb;
    --surface-3:#fdf6ef;
    --ink:#0d1433;
    --muted:#5f6f88;
    --line:rgba(13,20,51,0.1);
    --accent:#1c6bff;
    --accent-2:#ff6b35;
    --accent-3:#17c3b2;
    --accent-4:#f6bd60;
    --accent-5:#f46036;
    --success:#2fbf71;
    --warning:#ff9f1c;
    --danger:#ef476f;
    --shadow:0 20px 46px rgba(12, 20, 45, 0.12);
    --shadow-soft:0 12px 26px rgba(18, 28, 58, 0.08);
    --radius-lg:20px;
    --radius-md:16px;
    --radius-sm:12px;
    --font-base:"Manrope","Segoe UI",sans-serif;
    --font-display:"Space Grotesk","Manrope",sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--font-base);
    background:var(--bg);
    color:var(--ink);
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background:var(--bg-grad);
    z-index:-2;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    background:
      radial-gradient(380px 380px at 8% 90%, rgba(28,107,255,0.08), transparent 60%),
      radial-gradient(280px 280px at 92% 92%, rgba(246,189,96,0.12), transparent 55%);
    z-index:-1;
  }
  .shell{
    display:grid;
    grid-template-columns:260px 1fr;
    min-height:100dvh;
  }
.side{
      position:sticky;
      top:0;
      height:100dvh;
      padding:20px 16px;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:18px;
      border-right:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(235,244,255,0.92));
      backdrop-filter:blur(12px);
      box-shadow:0 12px 28px rgba(15,23,42,0.06);
    }
.brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:0;
      width:100%;
      border-radius:0;
      background:transparent;
      border:none;
      box-shadow:none;
      text-decoration:none;
    }
.brand img{
      width:176px;
      height:auto;
      object-fit:contain;
      filter:drop-shadow(0 10px 20px rgba(15,23,42,0.12));
    }
  .nav{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .nav a{
    display:flex;
    align-items:center;
    gap:12px;
    text-decoration:none;
    color:var(--ink);
    padding:12px 14px;
    border-radius:var(--radius-sm);
    border:1px solid transparent;
    background:linear-gradient(180deg, #ffffff, #f7f9ff);
    box-shadow:0 1px 0 rgba(14,20,43,0.05);
    transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .nav a:hover{
    transform:translateY(-1px);
    border-color:rgba(28,107,255,0.25);
    box-shadow:0 10px 20px rgba(28,107,255,0.15);
  }
  .nav a.active{
    background:linear-gradient(135deg, var(--accent), #458cff);
    color:#fff;
    border-color:transparent;
    box-shadow:0 14px 26px rgba(28,107,255,0.3);
  }
  .nav a span{
    font-weight:500;
    letter-spacing:.01em;
  }
.nav a svg{
      width:28px;
      height:28px;
      padding:8px;
      border-radius:14px;
      background:linear-gradient(140deg, rgba(76,156,255,0.22), rgba(23,195,178,0.18));
      color:#1f4b82;
      flex-shrink:0;
      box-shadow:inset 0 0 0 1px rgba(76,156,255,0.12);
    }
  .side-footer{
    margin-top:auto;
    font-size:12px;
    color:var(--muted);
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:18px;
    padding:22px 28px;
    background:rgba(255,255,255,0.9);
    border-bottom:1px solid var(--line);
    position:sticky;
    top:0;
    z-index:2;
    backdrop-filter:blur(8px);
  }
  .topbar-left h1{
    margin:0;
    font-size:1.8rem;
    font-family:var(--font-display);
    letter-spacing:.01em;
  }
  .topbar-left p{
    margin:6px 0 0;
    color:var(--muted);
    font-size:.98rem;
  }
  .topbar-actions{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .tenant-controls{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:#fff;
    box-shadow:var(--shadow-soft);
  }
  .tenant-controls.hidden{
    display:none;
  }
  .tenant-label{
    font-size:.78rem;
    color:var(--muted);
    font-weight:600;
  }
  .tenant-value{
    font-size:.86rem;
    font-weight:700;
    color:var(--ink);
    padding:4px 8px;
    border-radius:10px;
    background:var(--surface-2);
  }
  .tenant-select{
    min-width:160px;
    padding:6px 8px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#fff;
    font:inherit;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    font-size:.86rem;
    background:var(--surface-3);
    border:1px solid rgba(246,189,96,0.35);
    color:#9a5b1f;
    font-weight:600;
  }
  .logout-link{
    text-decoration:none;
    font-weight:600;
  }
  .logout-link:hover,
  .logout-link:focus,
  .logout-link:visited{
    font-weight:600;
  }
  .button{
    border:none;
    padding:10px 14px;
    border-radius:12px;
    font-weight:700;
    cursor:pointer;
  }
  .button.primary{
    background:linear-gradient(135deg, var(--accent-2), var(--accent-5));
    color:#fff;
    box-shadow:0 12px 24px rgba(255,107,53,0.35);
  }
  .button.secondary{
    background:#fff;
    border:1px solid var(--line);
    color:var(--ink);
  }
  main{
    padding:28px;
    display:flex;
    flex-direction:column;
    gap:20px;
  }
  .hero{
    background:linear-gradient(120deg, rgba(28,107,255,0.14), rgba(23,195,178,0.18));
    border:1px solid rgba(28,107,255,0.2);
    border-radius:var(--radius-lg);
    padding:24px;
    display:grid;
    grid-template-columns:2fr 1fr;
    gap:20px;
    box-shadow:var(--shadow);
  }
  .hero h2{
    margin:0 0 10px;
    font-size:1.6rem;
    font-family:var(--font-display);
  }
  .hero p{
    margin:0;
    color:#1f2a44;
    max-width:520px;
  }
  .hero-cards{
    display:grid;
    gap:12px;
  }
  .hero-card{
    background:rgba(255,255,255,0.8);
    border:1px solid rgba(28,107,255,0.18);
    border-radius:var(--radius-md);
    padding:12px 14px;
  }
  .hero-card strong{
    display:block;
    font-size:1.25rem;
    font-family:var(--font-display);
  }
  .hero-card span{
    color:var(--muted);
    font-size:.85rem;
  }
  .kpi-grid{
    display:grid;
    grid-template-columns:repeat(4, minmax(0,1fr));
    gap:14px;
  }
  .kpi-card{
    background:var(--surface);
    border-radius:var(--radius-md);
    padding:16px;
    border:1px solid var(--line);
    box-shadow:var(--shadow-soft);
    position:relative;
    overflow:hidden;
  }
  .kpi-card::after{
    content:"";
    position:absolute;
    inset:auto -40% -50% auto;
    width:140px;
    height:140px;
    border-radius:50%;
    opacity:.12;
    background:var(--accent);
  }
  .kpi-card h4{
    margin:0;
    font-size:.9rem;
    color:var(--muted);
    font-weight:600;
    letter-spacing:.02em;
  }
  .kpi-value{
    font-size:1.8rem;
    font-family:var(--font-display);
    margin-top:6px;
  }
  .kpi-sub{
    margin-top:6px;
    font-size:.85rem;
    color:var(--muted);
  }
  .kpi-progress{
    margin-top:12px;
    height:8px;
    border-radius:999px;
    background:#eef2ff;
    overflow:hidden;
  }
  .kpi-progress span{
    display:block;
    height:100%;
    width:0%;
    border-radius:999px;
    background:linear-gradient(90deg, var(--accent), var(--accent-3));
    transition:width .4s ease;
  }
  .kpi-tone-orange .kpi-progress span{background:linear-gradient(90deg, var(--accent-2), var(--accent-4))}
  .kpi-tone-teal .kpi-progress span{background:linear-gradient(90deg, var(--accent-3), #6ee7d4)}
  .kpi-tone-red .kpi-progress span{background:linear-gradient(90deg, var(--danger), #ff8fab)}
  .grid-two{
    display:grid;
    grid-template-columns:2fr 1fr;
    gap:14px;
  }
  .grid-three{
    display:grid;
    grid-template-columns:1.2fr 1fr 1fr;
    gap:14px;
  }
  .card{
    background:var(--surface);
    border-radius:var(--radius-md);
    padding:18px;
    border:1px solid var(--line);
    box-shadow:var(--shadow-soft);
  }
  .card h3{
    margin:0 0 12px;
    font-family:var(--font-display);
    font-size:1.1rem;
  }
  .card-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .card-sub{
    font-size:.82rem;
    color:var(--muted);
  }
  .chart-wrap{height:300px;}
  .chart-wrap.small{height:220px;}
  .status-list{
    display:grid;
    gap:8px;
    margin-top:10px;
  }
  .status-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-size:.9rem;
    color:var(--muted);
  }
  .status-pill{
    padding:4px 10px;
    border-radius:999px;
    font-weight:700;
    font-size:.75rem;
  }
  .status-ok{background:rgba(47,191,113,0.15); color:#168a4a;}
  .status-warn{background:rgba(255,159,28,0.2); color:#b45309;}
  .status-bad{background:rgba(239,71,111,0.2); color:#b91c1c;}
  .table-grid{
    display:grid;
    grid-template-columns:2fr 1fr;
    gap:14px;
    align-items:start;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:.88rem;
  }
  thead th{
    text-align:left;
    padding:10px 8px;
    background:var(--surface-2);
    border-bottom:1px solid var(--line);
    color:#1d2a46;
  }
  tbody td{
    padding:10px 8px;
    border-bottom:1px solid var(--line);
  }
  tbody tr{
    cursor:pointer;
    transition:background .18s ease;
  }
  tbody tr:hover{
    background:#f6f8ff;
  }
  tbody tr.active{
    background:rgba(28,107,255,0.12);
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    font-weight:700;
    font-size:.75rem;
  }
  .badge.ok{background:rgba(47,191,113,0.15); color:#168a4a;}
  .badge.warn{background:rgba(255,159,28,0.2); color:#b45309;}
  .badge.bad{background:rgba(239,71,111,0.2); color:#b91c1c;}
  .spotlight{
    display:grid;
    gap:12px;
  }
  .spotlight h4{
    margin:0;
    font-size:1rem;
    font-family:var(--font-display);
  }
  .spotlight .value{
    font-size:1.6rem;
    font-family:var(--font-display);
  }
  .spotlight-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  .spotlight-tile{
    background:var(--surface-2);
    border-radius:12px;
    padding:12px;
    border:1px solid var(--line);
  }
  .spotlight-tile span{
    display:block;
    font-size:.78rem;
    color:var(--muted);
  }
  .spotlight-tile strong{
    font-size:1.15rem;
  }
  .data-note{
    font-size:.8rem;
    color:var(--muted);
  }
  @media (max-width: 1200px){
    .kpi-grid{grid-template-columns:repeat(2, minmax(0,1fr))}
    .grid-two{grid-template-columns:1fr}
    .grid-three{grid-template-columns:1fr}
    .table-grid{grid-template-columns:1fr}
    .hero{grid-template-columns:1fr}
  }
  @media (max-width: 900px){
    .shell{grid-template-columns:1fr}
    .side{
      position:relative;
      height:auto;
      flex-direction:row;
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .nav{flex-direction:row; flex-wrap:wrap}
  }
  @media (max-width: 600px){
    header{flex-direction:column; align-items:flex-start}
    main{padding:20px}
    .kpi-grid{grid-template-columns:1fr}
  }
  /* STYLE-END */
</style>
  <link rel="stylesheet" href="../assets/items/app-shell.css" />
  <style>
    .side,
    .nav,
    .nav a,
    .nav a span{
      font-family:"Manrope","Segoe UI",sans-serif !important;
      font-weight:500 !important;
    }
    .nav a,
    .nav a span{
      font-weight:500 !important;
    }
    .nav a.active,
    .nav a:focus,
    .nav a:visited,
    .nav a:hover{
      font-weight:500 !important;
    }
  </style>
</head>
<body data-api-base="" data-app-page="insights" data-app-title="Clinicon Insights" data-app-subtitle="Stellenplan KPI Cockpit">
  <div class="shell">
    <!-- CONTENT-START -->
    <aside class="side">
  <a class="brand" href="start.html">
    <img src="../assets/pics/gfo-logo.png" alt="GFO Logo" />
  </a>
  <nav class="nav">
    <a href="start.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z"/></svg>
      <span>Start</span>
    </a>
    <a href="clinicon-assistent.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-2"/><path d="M12 4a4 4 0 0 1 4 4c0 2-2 3-2 4H10c0-1-2-2-2-4a4 4 0 0 1 4-4z"/></svg>
      <span>Clinicon Assistent</span>
    </a>
    <a href="stellenplan.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h10M4 18h7"/></svg>
      <span>Stellenplan</span>
    </a>
    <a href="stellenplan-insights.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M12 7v10"/><path d="M7 12h10"/></svg>
      <span>Stellenplan Insights</span>
    </a>
    <a href="stellenplan-gesamt.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      <span>Stellenplan Gesamt</span>
    </a>
    <a href="stellenplan-berechnung.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="18" rx="2"/><path d="M8 7h8"/><path d="M8 11h3"/><path d="M13 11h3"/><path d="M8 15h3"/><path d="M13 15h3"/></svg>
      <span>Stellenplan Berechnung</span>
    </a>
    <a href="klinikverbund.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="3" width="14" height="18" rx="2"/><path d="M9 3h6v4H9z"/></svg>
      <span>Klinikverbund</span>
    </a>
    <a href="benchmark.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19V5"/><path d="M4 19h16"/><path d="M7 14l3-3 4 4 5-6"/></svg>
      <span>Benchmark</span>
    </a>
    <a href="fachabteilungen.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h16M4 18h10"/></svg>
      <span>Fachabteilungen</span>
    </a>
    <a href="erfassung.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="3" width="14" height="18" rx="2"/><path d="M9 3h6v4H9z"/></svg>
      <span>Erfassung</span>
    </a>
  </nav>
</aside>

    <div>
      <header>
        <div class="topbar-left">
          <h1>Stellenplan Insights</h1>
          <p>Farbiges KPI-Dashboard mit Demo-Daten fuer erste Tests.</p>
        </div>
        <div class="topbar-actions app-actions" data-app-actions>
          <div class="tenant-controls hidden" data-tenant-controls>
            <span class="tenant-label">Mandant</span>
            <select id="tenantSelect" class="tenant-select"></select>
            <span id="tenantLabel" class="tenant-value" style="display:none;"></span>
            <span class="tenant-label">Abteilung</span>
            <select id="departmentSelect" class="tenant-select"></select>
          </div>
          <span class="pill app-pill" id="dataRange">Zeitraum: Demo</span>
          <span class="pill app-pill" id="tenantPill">Mandant: Demo</span>
          <button class="button app-button secondary" id="refreshButton" type="button">Aktualisieren</button>
          <button class="button app-button primary" type="button">Report exportieren</button>
          <a class="button app-button secondary logout-link" href="/cdn-cgi/access/logout">Logout</a>
        </div>
      </header>

      <main id="app-main">
      <!-- Content wird hier eingesetzt -->
      </main>
    </div>
    <!-- CONTENT-END -->
  </div>

  
  <script>
    (async () => {
      const apiBase = document.body.dataset.apiBase || "";
      const controls = document.querySelector("[data-tenant-controls]");
      const tenantSelect = document.getElementById("tenantSelect");
      const departmentSelect = document.getElementById("departmentSelect");
      const tenantLabel = document.getElementById("tenantLabel");
      const tenantPill = document.getElementById("tenantPill");
      if (!controls || !tenantSelect || !departmentSelect) return;

      try {
        const formatTenantDisplay = (label) => {
          const raw = String(label || "").trim();
          const normalized = raw.replace(/[^a-z0-9]/gi, "").toUpperCase();
          if (normalized.startsWith("GFO") && normalized.length === 6) {
            return `GFO-${normalized.slice(3)}`;
          }
          return raw.toUpperCase();
        };
        const setTenantPill = (label) => {
          if (!tenantPill) return;
          const clean = label ? formatTenantDisplay(label) : "Demo";
          tenantPill.textContent = `Mandant: ${clean}`;
        };
        const getAccessEmail = async () => {
          try {
            const cached = (sessionStorage.getItem("user_email") || "").trim();
            if (cached) return cached;
            const res = await fetch("/cdn-cgi/access/get-identity", { credentials: "same-origin" });
            if (!res.ok) throw new Error("identity fetch failed");
            const data = await res.json();
            const email = data && (data.email || data.user_email || data.user) ? String(data.email || data.user_email || data.user) : "";
            if (email) {
              sessionStorage.setItem("user_email", email);
              return email;
            }
          } catch (err) {
            // ignore
          }
          return (sessionStorage.getItem("user_email") || "").trim();
        };
        const normalizeTenantKey = (value) => String(value || "").toLowerCase().replace(/[^a-z0-9]/g, "");
        const getPathTenantInfo = () => {
          const segments = window.location.pathname.split("/").filter(Boolean);
          if (!segments.length) return { key: "", raw: "" };
          const maybeTenant = segments[0];
          const reserved = new Set(["pages", "assets", "api", "cdn-cgi"]);
          const normalized = normalizeTenantKey(maybeTenant);
          if (!normalized || reserved.has(normalized)) return { key: "", raw: "" };
          return { key: normalized, raw: String(maybeTenant || "") };
        };
        const buildTenantSlug = (code) => normalizeTenantKey(code);
        const pathTenantInfo = getPathTenantInfo();
        const pathTenantKey = pathTenantInfo.key;
        const pathTenantDisplay = pathTenantInfo.raw ? formatTenantDisplay(pathTenantInfo.raw) : "";
        if (pathTenantDisplay) {
          setTenantPill(pathTenantDisplay);
          sessionStorage.setItem("tenant_code", pathTenantDisplay);
        }
        const urlParams = new URLSearchParams(window.location.search);
        const devTenant = urlParams.get("devTenant");
        const accessEmail = await getAccessEmail();
        const tenantHeaders = { Accept: "application/json" };
        if (accessEmail) {
          tenantHeaders["x-user-email"] = accessEmail;
        }
        const buildTenantUrl = (base) =>
          devTenant ? `${base}/api/tenants?devTenant=${encodeURIComponent(devTenant)}` : `${base}/api/tenants`;
        const cacheKey = "tenant_cache";
        const cacheTtl = 5 * 60 * 1000;
        const cachedRaw = sessionStorage.getItem(cacheKey);
        let tenantData = null;
        if (cachedRaw) {
          try {
            const cached = JSON.parse(cachedRaw);
            if (cached && cached.ts && (Date.now() - cached.ts) < cacheTtl) {
              tenantData = cached.data || null;
            }
          } catch (err) {
            // ignore
          }
        }
        if (!tenantData) {
          let tenantRes = await fetch(buildTenantUrl(apiBase), { headers: tenantHeaders });
          if (!tenantRes.ok) {
            tenantRes = await fetch(buildTenantUrl("https://clinicon-stellenplan.maarten-koomen.workers.dev"), { headers: tenantHeaders });
          }
          if (!tenantRes.ok) return;
          tenantData = await tenantRes.json();
          sessionStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data: tenantData }));
        }
        const tenants = Array.isArray(tenantData.tenants) ? tenantData.tenants : [];
        const role = tenantData.role || "tenant";
        const showTenant = role === "admin" || role === "zpd";

        const storedTenant = Number.parseInt(sessionStorage.getItem("tenant_id"), 10);
        const activeTenantId = Number.isFinite(storedTenant)
          ? storedTenant
          : (tenantData.tenant && tenantData.tenant.id) ? tenantData.tenant.id : (tenants[0] && tenants[0].id);
        const matchedPathTenant = pathTenantKey
          ? tenants.find((t) => normalizeTenantKey(t.code || t.name) === pathTenantKey)
          : null;
        const resolvedTenantId = matchedPathTenant ? matchedPathTenant.id : activeTenantId;

        tenantSelect.innerHTML = tenants
          .map((t) => `<option value="${t.id}">${t.name || t.code}</option>`)
          .join("");
        if (resolvedTenantId) {
          tenantSelect.value = String(resolvedTenantId);
          document.body.dataset.tenantId = String(resolvedTenantId);
          sessionStorage.setItem("tenant_id", String(resolvedTenantId));
        }
        const activeTenant = tenants.find((t) => t.id === resolvedTenantId) || tenants[0];
        if (!pathTenantDisplay && activeTenant && (activeTenant.name || activeTenant.code)) {
          setTenantPill(activeTenant.name || activeTenant.code);
        }

        const needsTenantRedirect = !pathTenantKey && activeTenant;
        if (needsTenantRedirect) {
          const slug = buildTenantSlug(activeTenant.code || activeTenant.name);
          if (slug) {
            const target = `/${slug}/pages/start.html`;
            if (!window.location.pathname.startsWith(target)) {
              window.location.replace(target);
              return;
            }
          }
        }

        const buildDeptUrl = (base) =>
          `${base}/api/departments?tenant=${activeTenantId || ""}${devTenant ? `&devTenant=${encodeURIComponent(devTenant)}` : ""}`;
        let deptRes = await fetch(buildDeptUrl(apiBase), { headers: tenantHeaders });
        if (!deptRes.ok) {
          deptRes = await fetch(buildDeptUrl("https://clinicon-stellenplan.maarten-koomen.workers.dev"), { headers: tenantHeaders });
        }
        const deptData = deptRes.ok ? await deptRes.json() : { departments: [] };
        const departments = Array.isArray(deptData.departments) ? deptData.departments : [];
        const storedDept = Number.parseInt(sessionStorage.getItem("department_id"), 10);
        const activeDeptId = Number.isFinite(storedDept)
          ? storedDept
          : (departments[0] && departments[0].id);

        departmentSelect.innerHTML = departments
          .map((d) => `<option value="${d.id}">${d.name || d.code}</option>`)
          .join("");
        if (activeDeptId) {
          departmentSelect.value = String(activeDeptId);
          document.body.dataset.departmentId = String(activeDeptId);
        }

        controls.classList.remove("hidden");
        if (!showTenant) {
          tenantSelect.style.display = "none";
          if (tenantLabel && activeTenantId) {
            const activeTenant = tenants.find((t) => t.id === activeTenantId);
            tenantLabel.textContent = activeTenant ? (activeTenant.name || activeTenant.code) : "";
            tenantLabel.style.display = "inline-flex";
          }
        } else if (tenantLabel) {
          tenantLabel.style.display = "none";
        }

        if (showTenant) {
          tenantSelect.addEventListener("change", () => {
            sessionStorage.setItem("tenant_id", tenantSelect.value);
            sessionStorage.removeItem("department_id");
            window.location.reload();
          });
        }

        departmentSelect.addEventListener("change", () => {
          sessionStorage.setItem("department_id", departmentSelect.value);
          window.location.reload();
        });
      } catch (err) {
        // ignore
      }
    })();
  </script>

<script>
  (() => {
    const stamp = document.querySelector('[data-app-timestamp]');
    const updateTimestamp = () => {
      if (!stamp) return;
      const now = new Date();
      const label = now.toLocaleString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      stamp.textContent = `Stand: ${label}`;
    };
    updateTimestamp();
    setInterval(updateTimestamp, 60000);
  })();
</script>
</body>
</html>




