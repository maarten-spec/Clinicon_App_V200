<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinicon - Stellenplan Gesamt</title>
  <style id="page-style">
:root{
      --bg:#eef3f7; --panel:#ffffff; --muted:#94a3b8; --text:#0f172a; --line:#e2e8f0;
      --accent:#2563eb; --accent-weak:#dbeafe; --accent-strong:#1d4ed8; --shadow:0 18px 36px rgba(15,23,42,.08);
    }
main{
      padding:24px;
      display:flex;
      flex-direction:column;
      gap:18px;
      width:100%;
      max-width:none;
      margin:0 auto;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
      box-shadow:var(--shadow);
    }
    .hero{display:flex; flex-direction:column; gap:14px; padding:24px; border-radius:20px; width:100%; max-width:none; margin:0; box-sizing:border-box; background:linear-gradient(120deg,#f3f7ff 0%,#e8f1ff 40%,#f3f7ff 100%); border:1px solid #d9e4ff; box-shadow:0 18px 45px rgba(15,23,42,0.18);}
    .hero-top{display:flex; flex-wrap:wrap; justify-content:space-between; gap:14px; align-items:flex-start;}
    .hero-copy{display:flex; flex-direction:column; gap:6px;}
    .hero-pill{display:inline-flex; gap:8px; padding:9px 14px; border-radius:14px; background:linear-gradient(135deg,#1f4b82,#12355c); color:#fff; font-weight:700; box-shadow:0 12px 24px rgba(18,53,92,.25);}
    h1{margin:0;}
    .hero-meta{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:4px;}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; box-shadow:0 10px 20px rgba(15,23,42,.06); font-weight:700; color:var(--text);}
    .chip small{color:var(--muted); font-weight:600;}
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .controls label{display:flex; flex-direction:column; gap:4px; font-weight:600; color:var(--text);}
    .controls select{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font:inherit;
      background:#fff;
      min-width:140px;
    }
    .controls button{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid transparent;
      background:linear-gradient(135deg, #2563eb, #1d4ed8);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(37,99,235,.16);
    }
    table{width:100%; border-collapse:collapse;}
    th,td{padding:10px 7px; border-bottom:1px solid var(--line);}
    th{background:#f8fafc; text-align:left;}
    th.num, td.num{text-align:right;}
    th:first-child, td:first-child{text-align:left;}
    .totals-row td{font-weight:700; background:#f8fafc;}
    .plan-input{width:100%; max-width:120px; padding:8px 8px; border:1px solid var(--line); border-radius:10px; font:inherit; text-align:right;}
    .plan-input:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.16);}
    .delta-pos{color:#16a34a; font-weight:700;}
    .delta-neg{color:#b91c1c; font-weight:700;}
    .hint{color:var(--muted); font-size:.95rem;}
body[data-app-page="stellenplan-gesamt"] h1{font-family:var(--font-display);letter-spacing:.01em;}
body[data-app-page="stellenplan-gesamt"] .hero{background:linear-gradient(120deg, rgba(28,107,255,0.14), rgba(23,195,178,0.18));border:1px solid rgba(28,107,255,0.2);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:24px;}
body[data-app-page="stellenplan-gesamt"] .chip{border-radius:var(--radius-sm);border:1px solid rgba(28,107,255,0.18);background:rgba(255,255,255,0.8);box-shadow:var(--shadow-soft);}
@media(max-width:960px){
table{font-size:0.95rem;}
      th,td{padding:8px 6px;}
    }
    @media (max-width: 900px){

}
    @media (max-width: 600px){
}
@media (max-width: 900px){
}
  </style>
</head>
<body>
  <main class="page-fallback">
    <section class="card">
      <h1>Clinicon - Stellenplan Gesamt</h1>
      <p>Inhalt wird geladen. Falls die Seite leer bleibt, ist das Layout oder ein Skript blockiert.</p>
    </section>
  </main>

  <template id="page-content">
<section class="card hero">
          <div class="hero-top">
            <div class="hero-copy">
<h1>Alle Abteilungen in einer Uebersicht</h1>
              <p class="hint">Summiert VZae aus <strong>stellenplan_employees</strong> je Abteilung und Jahr.</p>
              <div class="hero-meta">
                <span class="chip"><small>Mandant</small><strong id="siteLabel">-</strong></span>
                <span class="chip"><small>Jahr</small><strong id="heroYear">-</strong></span>
                <span class="chip"><small>Abteilungen</small><strong id="heroDepts">-</strong></span>
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="controls">
            <label>Jahr
              <select id="yearSelect"></select>
            </label>
            <button id="btnRefresh" type="button">Neu laden</button>
          </div>
          <div id="status" class="hint" style="margin-top:10px;"></div>
          <div style="overflow:auto; margin-top:12px;">
            <table id="deptTable"></table>
          </div>
        </section>

<script>
    const MONTHS = ['Jan','Feb','Mrz','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
    const numberFormat = new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const SITE_LABEL = (sessionStorage.getItem('tenant_code') || sessionStorage.getItem('cliniconSite') || '').trim();

    const els = {
      yearSelect: document.getElementById('yearSelect'),
      btnRefresh: document.getElementById('btnRefresh'),
      status: document.getElementById('status'),
      deptTable: document.getElementById('deptTable'),
      siteLabel: document.getElementById('siteLabel'),
      heroYear: document.getElementById('heroYear'),
      heroDepts: document.getElementById('heroDepts'),
    };

    const state = {
      year: null,
      rows: [],
      planMap: {},
      deptIdMap: new Map(),
      yearsReady: false
    };

    function getApiBase(){
      return (document.body && document.body.dataset && document.body.dataset.apiBase) ? document.body.dataset.apiBase : '';
    }

    function getContextIds(){
      const body = document.body || {};
      const tenantId = body.dataset?.tenantId || sessionStorage.getItem('tenant_id') || '';
      const tenant = Number.parseInt(tenantId, 10);
      return { tenantId: Number.isFinite(tenant) ? tenant : null };
    }

    async function fetchJson(url, options = {}){
      const headers = { 'content-type': 'application/json', accept: 'application/json' };
      const response = await fetch(`${getApiBase()}${url}`, {
        headers,
        credentials: 'same-origin',
        ...options
      });
      if(!response.ok){
        const text = await response.text();
        throw new Error(text || `HTTP ${response.status}`);
      }
      const contentType = response.headers.get('content-type') || '';
      if(!contentType.includes('application/json')){
        throw new Error(`Non-JSON response: ${contentType}`);
      }
      return response.json();
    }

    function fmt(n){
      const num = Number(n || 0);
      return numberFormat.format(num);
    }

    function setStatus(msg, ok=true){
      els.status.textContent = msg;
      els.status.style.color = ok ? '#16a34a' : '#b91c1c';
    }

    function parseMonths(arr){
      if(Array.isArray(arr)) return arr.map(v=>Number(v)||0);
      if(typeof arr === 'string'){
        const cleaned = arr.replace(/[{}]/g,'');
        if(!cleaned) return Array(12).fill(0);
        return cleaned.split(',').map(v=>Number(v)||0);
      }
      return Array(12).fill(0);
    }

    function buildDeptOrder(departments){
      const order = [];
      const seen = new Set();
      state.deptIdMap = new Map();
      (departments || []).forEach(d=>{
        const label = d.name || d.code || String(d.id);
        if(d.name) state.deptIdMap.set(d.name, d.id);
        if(d.code) state.deptIdMap.set(d.code, d.id);
        if(label && !seen.has(label)){
          seen.add(label);
          order.push(label);
        }
      });
      return order;
    }

    function aggregate(entries, deptOrder){
      const map = new Map();
      const ensure = (dept) => {
        if(!map.has(dept)){
          map.set(dept, { dept, empCount:0, months:Array(12).fill(0) });
        }
        return map.get(dept);
      };
      (deptOrder || []).forEach(ensure);
      (entries || []).filter(e=>e.include!==false).forEach(e=>{
        const dept = (e.dept || e.extra_category || 'Station').trim() || 'Station';
        const target = ensure(dept);
        target.empCount += 1;
        const months = parseMonths(e.months ?? e.values);
        months.forEach((v,i)=> target.months[i]+=Number(v)||0);
      });
      const ordered = [];
      (deptOrder || []).forEach(d=>{ if(map.has(d)) ordered.push(map.get(d)); });
      map.forEach((val,key)=>{ if(!(deptOrder || []).includes(key)) ordered.push(val); });
      return ordered;
    }

    function getPlanValue(dept){
      return Number(state.planMap[dept] || 0);
    }

    function loadPlanValues(planByDept){
      state.planMap = planByDept || {};
    }

    async function setPlanValueDb(dept, value){
      const deptId = state.deptIdMap.get(dept);
      const ctx = getContextIds();
      if(!deptId || !ctx.tenantId) return;
      const months = new Array(12).fill(Number(value)||0);
      const payload = {
        year: state.year,
        employees: [],
        extras: [],
        planTargets: { months },
        tenantId: ctx.tenantId,
        departmentId: deptId
      };
      await fetchJson('/api/stellenplan', { method:'POST', body: JSON.stringify(payload) });
    }

    function renderTable(rows){
      const safeRows = rows || [];
      if(!safeRows.length){
        els.deptTable.innerHTML = '<tr><td>Keine Daten gefunden.</td></tr>';
        if(els.heroDepts) els.heroDepts.textContent = '0';
        return;
      }
      const header = `<tr>
        <th>Abteilung</th>
        <th class="num">Wirtschaftsplan (VK)</th>
        ${MONTHS.map(m=>`<th class="num">${m}</th>`).join('')}
        <th class="num">&Oslash; Jahr</th>
        <th class="num">Abweichung</th>
        <th class="num">Koepfe</th>
      </tr>`;
      const body = safeRows.map(r=>{
        const total = r.months.reduce((a,b)=>a+b,0);
        const avgYear = total/12;
        const plan = getPlanValue(r.dept);
        const delta = avgYear - plan;
        const deltaClass = delta >= 0 ? 'delta-pos' : 'delta-neg';
        const safeDept = String(r.dept || '').replace(/"/g,'&quot;');
        return `<tr>
          <td>${r.dept}</td>
          <td class="num"><input class="plan-input" type="number" step="0.01" data-plan-dept="${safeDept}" value="${plan.toFixed(2)}" /></td>
          ${r.months.map(v=>`<td class="num">${fmt(v)}</td>`).join('')}
          <td class="num">${fmt(avgYear)}</td>
          <td class="num ${deltaClass}">${fmt(delta)}</td>
          <td class="num">${r.empCount}</td>
        </tr>`;
      }).join('');
      const totals = safeRows.reduce((acc, r) => {
        acc.emp += r.empCount;
        r.months.forEach((v,i)=> acc.months[i]+=v);
        return acc;
      }, { emp:0, months:Array(12).fill(0) });
      const totalYear = totals.months.reduce((a,b)=>a+b,0);
      const avgYearTotal = totalYear/12;
      const planTotal = safeRows.reduce((sum,r)=>sum + getPlanValue(r.dept),0);
      const deltaTotal = avgYearTotal - planTotal;
      const deltaTotalClass = deltaTotal >= 0 ? 'delta-pos' : 'delta-neg';
      const footer = `<tr class="totals-row">
        <td>Gesamt</td>
        <td class="num">${fmt(planTotal)}</td>
        ${totals.months.map(v=>`<td class="num">${fmt(v)}</td>`).join('')}
        <td class="num">${fmt(avgYearTotal)}</td>
        <td class="num ${deltaTotalClass}">${fmt(deltaTotal)}</td>
        <td class="num">${totals.emp}</td>
      </tr>`;
      els.deptTable.innerHTML = header + body + footer;
      if(els.heroDepts) els.heroDepts.textContent = safeRows.length;
    }

    async function loadData(){
      setStatus('Lade Daten ...', true);
      const ctx = getContextIds();
      const params = new URLSearchParams({ year: String(state.year || new Date().getFullYear()) });
      if(ctx.tenantId) params.set('tenant', String(ctx.tenantId));
      const payload = await fetchJson(`/api/stellenplan/entries?${params.toString()}`);
      const entries = Array.isArray(payload.entries) ? payload.entries : [];
      const years = Array.isArray(payload.years) ? payload.years.filter(Boolean) : [];
      if(!state.yearsReady){
        const list = years.length ? years : [payload.year || new Date().getFullYear()];
        els.yearSelect.innerHTML = list.map(y=>`<option value="${y}">${y}</option>`).join('');
        state.yearsReady = true;
      }
      state.year = Number(payload.year || state.year || new Date().getFullYear());
      els.yearSelect.value = state.year;
      if(els.heroYear) els.heroYear.textContent = state.year;
      const tenantLabel = payload.tenant && (payload.tenant.code || payload.tenant.name)
        ? (payload.tenant.code || payload.tenant.name)
        : (SITE_LABEL || '-');
      if(els.siteLabel) els.siteLabel.textContent = tenantLabel;
      const deptOrder = buildDeptOrder(payload.departments || []);
      loadPlanValues(payload.plan_by_dept || {});
      const rows = aggregate(entries, deptOrder);
      state.rows = rows;
      renderTable(rows);
      setStatus('Fertig.');
    }

    function bindEvents(){
      els.yearSelect.addEventListener('change', ()=>{
        state.year = Number(els.yearSelect.value);
        if(els.heroYear) els.heroYear.textContent = state.year;
        loadData().catch(err=>setStatus(err.message, false));
      });
      els.btnRefresh.addEventListener('click', ()=>{
        loadData().catch(err=>setStatus(err.message, false));
      });
      els.deptTable.addEventListener('change', event=>{
        const target = event.target;
        if(!(target instanceof HTMLInputElement)) return;
        if(!target.dataset.planDept) return;
        const dept = target.dataset.planDept || '';
        const val = parseFloat(target.value);
        const num = Number.isFinite(val) ? val : 0;
        state.planMap[dept] = num;
        setPlanValueDb(dept, num).catch(err=>setStatus(err.message, false));
        renderTable(state.rows);
      });
    }

    (async function init(){
      bindEvents();
      try{
        await loadData();
      }catch(err){
        setStatus(err.message, false);
      }
    })();
  </script>
  </template>

  <script>
    const __pageContent = document.getElementById("page-content")?.innerHTML || "";
    const __pageStyle = document.getElementById("page-style")?.textContent || "";
    const __pageTitle = document.title || "";
    const __fallback = document.querySelector(".page-fallback");

    const mountLayout = (html) => {
      const parser = new DOMParser();
      const layoutDoc = parser.parseFromString(html, "text/html");
      const layoutHead = layoutDoc.head;
      const layoutBody = layoutDoc.body;

      document.head.querySelectorAll("[data-layout]").forEach((node) => node.remove());
      Array.from(layoutHead.children).forEach((node) => {
        if (node.tagName === "STYLE" || node.tagName === "LINK") {
          const clone = node.cloneNode(true);
          clone.setAttribute("data-layout", "true");
          document.head.appendChild(clone);
        }
      });

      document.body.innerHTML = layoutBody.innerHTML;

      Array.from(layoutBody.attributes).forEach((attr) => {
        document.body.setAttribute(attr.name, attr.value);
      });

      if (__pageStyle) {
        const style = document.createElement("style");
        style.setAttribute("data-page-style", "true");
        style.textContent = __pageStyle;
        document.head.appendChild(style);
      }

      if (__pageTitle) {
        document.title = __pageTitle;
        const headerTitle = document.querySelector(".topbar-left h1");
        if (headerTitle) {
          headerTitle.textContent = __pageTitle;
        }
      }

            const runScriptNodes = (nodes) => {
        const runScripts = (index) => {
          if (index >= nodes.length) return;
          const oldScript = nodes[index];
          const script = document.createElement("script");
          Array.from(oldScript.attributes).forEach((attr) => {
            script.setAttribute(attr.name, attr.value);
          });
          script.async = false;
          if (oldScript.textContent) {
            script.textContent = oldScript.textContent;
          }
          const next = () => runScripts(index + 1);
          if (script.src) {
            script.onload = next;
            script.onerror = next;
          }
          oldScript.replaceWith(script);
          if (!script.src) {
            next();
          }
        };
        runScripts(0);
      };

      const layoutScripts = Array.from(document.body.querySelectorAll("script"));
      if (layoutScripts.length) {
        runScriptNodes(layoutScripts);
      }

      const slot = document.getElementById("app-main") || document.querySelector("main");
      if (slot) {
        slot.innerHTML = __pageContent;
        const slotScripts = Array.from(slot.querySelectorAll("script"));
        if (slotScripts.length) {
          runScriptNodes(slotScripts);
        }
      }

      const current = (location.pathname.split("/").pop() || "").toLowerCase();
      document.querySelectorAll(".nav a[href]").forEach((a) => a.classList.remove("active"));
      document.querySelectorAll(".nav a[href]").forEach((a) => {
        const href = (a.getAttribute("href") || "").split("?")[0].split("#")[0].toLowerCase();
        if (href && href === current) {
          a.classList.add("active");
        }
      });
    };

    fetch("./layout.html?v=20260205")
      .then((r) => {
        if (!r.ok) {
          throw new Error(`Layout HTTP ${r.status}`);
        }
        return r.text();
      })
      .then(mountLayout)
      .catch((err) => {
        console.error("Layout load failed", err);
        if (__fallback) {
          __fallback.style.display = "block";
        }
      });
  </script>
</body>
</html>














